!function(){let e=document.getElementById("fitFile"),t=document.getElementById("status"),n=document.getElementById("sessionTableBody"),r=document.getElementById("legTableBody"),i=document.getElementById("mainChart"),a=document.getElementById("routeMap"),l=document.getElementById("downloadJsonBtn"),o=document.getElementById("downloadTcxBtn"),s=document.getElementById("exportStatus"),d={fileName:null,rawData:null,sessions:[],records:[],legs:[],boundaries:[],t0:null,tEnd:null,chart:null,chartT0Ms:null,drag:{active:!1,boundaryIndex:null},interactionsSetup:!1,map:null,mapPolyline:null,activeLegIndex:null};if(!e){console.error("File input #fitFile not found");return}function u(e){t&&(t.textContent=e),console.log("[Multisport breaker]",e)}function p(e){s&&(s.textContent=e||"")}function c(){let e=d.legs,t=d.boundaries;if(e.length){for(let n=0;n<t.length;n++){let r=t[n].time,i=e[n],a=e[n+1];i&&(i.end=r),a&&(a.start=r)}e.forEach(e=>{e.start instanceof Date&&e.end instanceof Date&&(e.durationSec=(e.end.getTime()-e.start.getTime())/1e3)})}}function m(){if(r.innerHTML="",!d.legs.length){let e=document.createElement("tr"),t=document.createElement("td");t.colSpan=8,t.textContent="No legs detected.",e.appendChild(t),r.appendChild(e);return}d.legs.forEach((e,t)=>{let n=document.createElement("tr"),i=document.createElement("td");i.className="leg-radio-cell";let a=document.createElement("input");a.type="radio",a.name="activeLeg",a.className="leg-radio",a.dataset.legIndex=String(t),a.checked=d.activeLegIndex===t,a.addEventListener("change",g),i.appendChild(a),n.appendChild(i),T(n,e.index),T(n,e.sport),T(n,e.subsport),T(n,e.isTransition?"Yes":""),T(n,v(e.start)),T(n,v(e.end)),T(n,I(e.durationSec)),r.appendChild(n)})}function g(e){let t=Number(e.target.dataset.legIndex);!Number.isNaN(t)&&d.legs[t]&&(d.activeLegIndex=t,p(`Selected leg #${d.legs[t].index} for TCX export.`))}function f(){if(!d.boundaries.length||null==d.chartT0Ms)return[];let e=d.chartT0Ms;return d.boundaries.map(t=>{let n=S(t.time);return{tMin:(n-e)/6e4}})}function h(e){if(!d.chart||!d.boundaries.length)return;let t=d.chart.scales.x;if(!t)return;let n=i.getBoundingClientRect(),r=e.clientX-n.left,a=d.boundaries.map(e=>{let n=S(e.time),r=(n-d.chartT0Ms)/6e4;return t.getPixelForValue(r)}),l=null,o=1/0;a.forEach((e,t)=>{let n=Math.abs(e-r);n<o&&(o=n,l=t)}),null!=l&&o<=10&&(d.drag.active=!0,d.drag.boundaryIndex=l)}function y(e){if(!d.drag.active||null==d.drag.boundaryIndex||!d.chart)return;let t=d.drag.boundaryIndex,n=d.chart.scales.x;if(!n)return;let r=i.getBoundingClientRect(),a=e.clientX-r.left,l=n.getValueForPixel(a);if(!isFinite(l))return;let o=d.chartT0Ms+6e4*l,s=d.legs;if(!s[t]||!s[t+1])return;let u=s[t].start.getTime()+1e3,p=s[t+1].end.getTime()-1e3;u<p&&(o<u&&(o=u),o>p&&(o=p)),d.boundaries[t].time=new Date(o),c(),m(),function e(){if(!d.chart)return;let t=f();d.chart.options.plugins.boundaryLines.boundaries=t,d.chart.update("none")}()}function $(){d.drag.active=!1,d.drag.boundaryIndex=null}function b(e){let t=d.rawData?.record||d.rawData?.records||[];if(!t.length)return[];let n=e.start instanceof Date?e.start.getTime():NaN,r=e.end instanceof Date?e.end.getTime():NaN;return isFinite(n)&&isFinite(r)?t.filter(e=>{let t=S(e.timestamp);return t>=n&&t<=r}):[]}function x(e,t,n){let r=new Blob([e],{type:n}),i=URL.createObjectURL(r),a=document.createElement("a");a.href=i,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)}function T(e,t){let n=document.createElement("td");n.textContent=t,e.appendChild(n)}function w(e){if(e instanceof Date)return e;if(null==e)return null;let t=new Date(e);return isNaN(t.getTime())?null:t}function S(e){if(e instanceof Date)return e.getTime();if(null==e)return NaN;let t=new Date(e);return isNaN(t.getTime())?NaN:t.getTime()}function v(e){return!(e instanceof Date)||isNaN(e.getTime())?"":e.toLocaleString()}function I(e){if("number"!=typeof e||!isFinite(e)||e<0)return"";let t=Math.round(e),n=e=>String(e).padStart(2,"0");return`${n(Math.floor(t/3600))}:${n(Math.floor(t%3600/60))}:${n(t%60)}`}e.addEventListener("change",function e(t){let r=t.target.files[0];if(!r){u("No file selected.");return}if(!r.name.toLowerCase().endsWith(".fit")){u("Selected file does not look like a .fit file.");return}u(`Loading file "${r.name}"...`),p("");let l=new FileReader;l.onload=function(e){let t=e.target.result;(function e(t,r){if(u("Parsing FIT file..."),"undefined"==typeof FitParser){console.error("FitParser is not available on window"),u("Internal error: FitParser not loaded.");return}d.chart&&(d.chart.destroy(),d.chart=null);let l=new FitParser({force:!0,speedUnit:"m/s",lengthUnit:"m",temperatureUnit:"celsius",elapsedRecordField:!0,mode:"list"});l.parse(t,function(e,t){if(e){console.error("FIT parse error:",e),u("Error while parsing FIT file. See console.");return}console.log("Parsed FIT data:",t);let l=t.session||t.sessions||[],o=t.record||t.records||[];d.fileName=r,d.rawData=t,d.sessions=l,d.records=o,d.activeLegIndex=null,u(`Parsed "${r}". Found ${l.length} session(s) and ${o.length} record(s).`),function e(t){if(n.innerHTML="",!t||0===t.length){let r=document.createElement("tr"),i=document.createElement("td");i.colSpan=6,i.textContent="No session messages found.",r.appendChild(i),n.appendChild(r);return}t.map((e,t)=>({index:t,session:e})).sort((e,t)=>{let n=S(e.session.start_time||e.session.timestamp||0),r=S(t.session.start_time||t.session.timestamp||0);return n-r}).forEach(({index:e,session:t})=>{let r=document.createElement("tr"),i=w(t.start_time||t.timestamp),a=null;"number"==typeof t.total_elapsed_time?a=t.total_elapsed_time:"number"==typeof t.total_timer_time&&(a=t.total_timer_time);let l=i&&"number"==typeof a?new Date(i.getTime()+1e3*a):null,o=void 0!==t.sport?String(t.sport):"(unknown)",s=void 0!==t.sub_sport?String(t.sub_sport):"";T(r,e+1),T(r,o),T(r,s),T(r,i?i.toString():""),T(r,l?l.toString():""),T(r,null!=a?I(a):""),n.appendChild(r)})}(l),function e(){let t=d.sessions||[],n=d.records||[];if(d.legs=[],d.boundaries=[],d.t0=null,d.tEnd=null,!t.length||!n.length)return;let r=t.map((e,t)=>{let n=w(e.start_time||e.timestamp||0),r="number"==typeof e.total_elapsed_time?e.total_elapsed_time:"number"==typeof e.total_timer_time?e.total_timer_time:0,i=n?new Date(n.getTime()+1e3*r):w(e.timestamp||0),a=(e.sport||"").toString(),l=(e.sub_sport||"").toString(),o="transition"===a.toLowerCase();return{index:t+1,sport:a,subsport:l,isTransition:o,start:n,end:i,durationSec:r}}).filter(e=>e.start&&e.end).sort((e,t)=>e.start-t.start);if(d.legs=r,!r.length)return;d.t0=r[0].start,d.tEnd=r[r.length-1].end;let i=[];for(let a=0;a<r.length-1;a++){let l=r[a],o=r[a+1],s=(l.end.getTime()+o.start.getTime())/2;i.push({index:a,time:new Date(s),leftLeg:a,rightLeg:a+1})}d.boundaries=i,c()}(),m(),function e(){if(!i||!d.records.length)return;let t=d.records.slice().sort((e,t)=>{let n=S(e.timestamp),r=S(t.timestamp);return n-r});if(!t.length)return;let n=S(t[0].timestamp);d.chartT0Ms=n;let r=t.map(e=>{let t=S(e.timestamp);return{tMin:(t-n)/6e4,power:"number"==typeof e.power?e.power:null,hr:"number"==typeof e.heart_rate?e.heart_rate:"number"==typeof e.heartRate?e.heartRate:null}}),a=Math.max(1,Math.floor(r.length/2e3)),l=r.filter((e,t)=>t%a==0),o=l.map(e=>({x:e.tMin,y:e.power})),s=l.map(e=>({x:e.tMin,y:e.hr})),u=f(),p=i.getContext("2d");d.chart=new Chart(p,{type:"line",data:{datasets:[{label:"Power (W)",data:o,yAxisID:"y",pointRadius:0,borderWidth:1,borderColor:"#4ac6ff"},{label:"Heart rate (bpm)",data:s,yAxisID:"y1",pointRadius:0,borderWidth:1,borderColor:"#ff6b9c"},]},options:{responsive:!0,animation:!1,parsing:!1,plugins:{legend:{display:!0,labels:{usePointStyle:!0,font:{size:11}}},boundaryLines:{boundaries:u}},scales:{x:{type:"linear",title:{display:!0,text:"Time (min from file start)"},ticks:{maxTicksLimit:10}},y:{position:"left",title:{display:!0,text:"Power (W)"}},y1:{position:"right",title:{display:!0,text:"Heart rate (bpm)"},grid:{drawOnChartArea:!1}}}},plugins:[{id:"boundaryLines",afterDraw(e,t,n){let{ctx:r,chartArea:i}=e,a=e.scales.x;a&&(r.save(),r.lineWidth=1,r.setLineDash([4,4]),r.strokeStyle="rgba(255,255,255,0.65)",(n.boundaries||[]).forEach(e=>{let t=a.getPixelForValue(e.tMin);t<i.left||t>i.right||(r.beginPath(),r.moveTo(t,i.top),r.lineTo(t,i.bottom),r.stroke())}),r.restore())}}]})}(),function e(){if(!a)return;let t=d.records||[],n=t.filter(e=>"number"==typeof e.position_lat&&"number"==typeof e.position_long).map(e=>[e.position_lat,e.position_long]);if(!n.length){a.innerHTML='<div class="route-map-placeholder">No GPS coordinates in this file.</div>';return}a.innerHTML="",d.map?d.mapPolyline&&(d.map.removeLayer(d.mapPolyline),d.mapPolyline=null):(d.map=L.map("routeMap",{zoomControl:!0}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"&copy; OpenStreetMap contributors"}).addTo(d.map)),d.mapPolyline=L.polyline(n,{weight:3}),d.mapPolyline.addTo(d.map),d.map.fitBounds(d.mapPolyline.getBounds(),{padding:[12,12]})}(),!d.interactionsSetup&&i&&(d.interactionsSetup=!0,i.addEventListener("mousedown",h),window.addEventListener("mousemove",y),window.addEventListener("mouseup",$)),p("")})})(t,r.name)},l.onerror=function(e){console.error(e),u("Error reading file.")},l.readAsArrayBuffer(r)}),l&&l.addEventListener("click",function e(t){if(t.preventDefault(),!d.legs.length){u("Nothing to export yet.");return}let n={fileName:d.fileName,generatedAt:new Date().toISOString(),legs:d.legs.map(e=>{let t=b(e);return{index:e.index,sport:e.sport,subsport:e.subsport,isTransition:e.isTransition,start:e.start.toISOString(),end:e.end.toISOString(),durationSec:e.durationSec,records:t.map(e=>{let{timestamp:t,...n}=e,r=t instanceof Date?t.toISOString():new Date(t).toISOString();return{timestamp:r,...n}})}})},r=JSON.stringify(n);x(r,(d.fileName||"multisport").replace(/\.fit$/i,"")+".legs-debug.json","application/json"),u("Debug JSON downloaded.")}),o&&o.addEventListener("click",function e(t){if(t.preventDefault(),!d.legs.length){p("Nothing to export yet. Load a multisport .FIT first.");return}if(null==d.activeLegIndex||!d.legs[d.activeLegIndex]){p("Select a leg in the table first.");return}let n=d.legs[d.activeLegIndex],r=b(n);if(!r.length){p("Selected leg has no records in that time span.");return}let i=n.start.toISOString(),a="";r.forEach(e=>{let t=e.timestamp instanceof Date?e.timestamp.toISOString():new Date(e.timestamp).toISOString(),n="number"==typeof e.position_lat?e.position_lat.toFixed(7):null,r="number"==typeof e.position_long?e.position_long.toFixed(7):null,i="number"==typeof e.altitude?e.altitude:"number"==typeof e.enhanced_altitude?e.enhanced_altitude:null,l="number"==typeof e.distance?e.distance:"number"==typeof e.enhanced_distance?e.enhanced_distance:null,o="number"==typeof e.heart_rate?e.heart_rate:"number"==typeof e.heartRate?e.heartRate:null,s="number"==typeof e.power?e.power:"number"==typeof e.watts?e.watts:null,d="number"==typeof e.enhanced_speed?e.enhanced_speed:"number"==typeof e.speed?e.speed:null,u="number"==typeof e.cadence?e.cadence:"number"==typeof e.cad?e.cad:null,p="number"==typeof e.temperature?e.temperature:null;a+="          <Trackpoint>\n",a+=`            <Time>${t}</Time>
`,null!=n&&null!=r&&(a+="            <Position>\n",a+=`              <LatitudeDegrees>${n}</LatitudeDegrees>
`,a+=`              <LongitudeDegrees>${r}</LongitudeDegrees>
`,a+="            </Position>\n"),null!=i&&(a+=`            <AltitudeMeters>${i.toFixed(1)}</AltitudeMeters>
`),null!=l&&(a+=`            <DistanceMeters>${l.toFixed(1)}</DistanceMeters>
`),null!=o&&(a+="            <HeartRateBpm>\n",a+=`              <Value>${Math.round(o)}</Value>
`,a+="            </HeartRateBpm>\n"),null!=p&&(a+=`            <Temperature>${Math.round(p)}</Temperature>
`),(null!=s||null!=d||null!=u)&&(a+="            <Extensions>\n",a+="              <ns3:TPX>\n",null!=s&&(a+=`                <ns3:Watts>${Math.round(s)}</ns3:Watts>
`),null!=d&&(a+=`                <ns3:Speed>${d.toFixed(3)}</ns3:Speed>
`),null!=u&&(a+=`                <ns3:Cadence>${Math.round(u)}</ns3:Cadence>
`),a+="              </ns3:TPX>\n",a+="            </Extensions>\n"),a+="          </Trackpoint>\n"});let l=r[r.length-1],o=0;l&&("number"==typeof l.distance?o=l.distance:"number"==typeof l.enhanced_distance&&(o=l.enhanced_distance));let s=n.durationSec||0,u=`<?xml version="1.0" encoding="UTF-8"?>
<TrainingCenterDatabase xmlns="http://www.garmin.com/xmlschemas/TrainingCenterDatabase/v2"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:ns3="http://www.garmin.com/xmlschemas/ActivityExtension/v2">
  <Activities>
    <Activity Sport="Other">
      <Id>${i}</Id>
      <Lap StartTime="${i}">
        <TotalTimeSeconds>${s.toFixed(1)}</TotalTimeSeconds>
        <DistanceMeters>${o.toFixed(1)}</DistanceMeters>
        <Track>
`+a+"        </Track>\n      </Lap>\n    </Activity>\n  </Activities>\n</TrainingCenterDatabase>\n",c=(d.fileName||"multisport").replace(/\.fit$/i,""),m=`.leg-${n.index}.tcx`;x(u,c+m,"application/vnd.garmin.tcx+xml"),p(`Downloaded TCX for leg #${n.index}.`)})}();
